

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>HRG packagingの利用方法(開発者向け) &mdash; HRG packaging 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="HRG packaging 0.1 documentation" href="index.html"/>
        <link rel="prev" title="HRG packagingの利用方法(ユーザ向け)" href="user.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> HRG packaging
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="user.html">HRG packagingの利用方法(ユーザ向け)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">HRG packagingの利用方法(開発者向け)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">はじめに</a></li>
<li class="toctree-l2"><a class="reference internal" href="#launchpad-daily-build">launchpad Daily Build機能の仕組み</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hrg-packagingrecipe">HRG packagingのソースコードとrecipe</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bzr">パッケージの更新に必要なbzrコマンド集</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#launchpad">launchpadコードレポジトリの利用に必要な初期設定</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">ビルドに必要な依存ライブラリの追加</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">バージョン番号の更新</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">ビルドの手動トリガ</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id7">ビルド通知、自動ビルドの制御</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id8">ビルドを行うオペレーティングシステムの種類を追加・削除する方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">ビルドする対象ソフトウェアを追加・削除する方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id10">ビルドの前処理・後処理を変更する方法</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">HRG packaging</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>HRG packagingの利用方法(開発者向け)</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/developer.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hrg-packaging">
<h1>HRG packagingの利用方法(開発者向け)<a class="headerlink" href="#hrg-packaging" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id1">
<h2>はじめに<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>HRG packagingはlaunchpadのPPAサービスを使って、hrpsys-base, choreonoid, OpenHRPなどのロボット関連ソフトウェアの最新版を容易にインストールできるようにしたパッケージです。</p>
<p>このドキュメントではlaunchpadのPPAサービスの利用方法を説明します。</p>
</div>
<div class="section" id="launchpad-daily-build">
<h2>launchpad Daily Build機能の仕組み<a class="headerlink" href="#launchpad-daily-build" title="Permalink to this headline">¶</a></h2>
<p>launchpadにはソースコードの最新版を毎日ビルドして自動でパッケージ化してくれるDaily Buildという機能があります。</p>
<p>Daily Buildではビルド元のソースコードはすべてlaunchpadのコードレポジトリに登録しなければなりません。ただし、外部のコードレポジトリでホストされたソースコードでもビルドできるように、ソースコードをlaunchpadのコードレポジトリに定期的にミラーする機能があります。</p>
<p>HRG packagingでは、hrpsys-base, choreonoid, OpenHRPの各ソースコードについてはgithubからミラーするように設定し、パッケージをビルドするために必要なdebianフォルダ以下の各設定ファイルについてはlaunchpadで直接ホストしています。</p>
<p>ソースコードと設定ファイルはrecipeの設定によって一つのソースツリーの形に再構成されビルドが行われます。下の図は2つのフォルダからひとつのソースツリーを構成する例となっていますが、recipeの設定で任意の数のフォルダを再構成することができます。</p>
<p class="graphviz">
<img src="_images/graphviz-178632ab83da27abc36cd109ce9f29cf2a5383c5.png" alt="digraph foo {
   &quot;source(github,git)&quot; -&gt; &quot;mirror(launchpad,bzr)&quot;
   &quot;mirror(launchpad,bzr)&quot; -&gt; &quot;recipe&quot;
   &quot;debian(launchpad,bzr)&quot; -&gt; &quot;recipe&quot;
   &quot;recipe&quot; -&gt; &quot;build&quot;
}" />
</p>
</div>
<div class="section" id="hrg-packagingrecipe">
<h2>HRG packagingのソースコードとrecipe<a class="headerlink" href="#hrg-packagingrecipe" title="Permalink to this headline">¶</a></h2>
<p>ソースコードについては以下のURLから閲覧できます。<a href="#id2"><span class="problematic" id="id3">*</span></a>-debとなっているソースコードについては各ソフトウェアのパッケージのビルドに必要なdebianフォルダの内容です。それ以外のソースコードは外部レポジトリのミラーです。</p>
<p><a class="reference external" href="https://code.launchpad.net/hrg-packaging">https://code.launchpad.net/hrg-packaging</a></p>
<p>Daily Buildを行うための設定(recipeと呼ばれる)は以下のURLから閲覧できます。パッケージ作成の元となるソースコード(ベースブランチ)にdebianフォルダ部分をオーバーレイしてビルドする設定が格納されています。</p>
<p><a class="reference external" href="https://code.launchpad.net/~hrg/+recipes">https://code.launchpad.net/~hrg/+recipes</a></p>
<p>recipeのページからビルド状況の確認やビルドの手動トリガを出すこともできます(後で詳述します)。</p>
</div>
<div class="section" id="bzr">
<h2>パッケージの更新に必要なbzrコマンド集<a class="headerlink" href="#bzr" title="Permalink to this headline">¶</a></h2>
<p>ソフトウェア本体の修正については元の外部レポジトリのソースコードを修正することで、その変更が自動でミラーされ定期ビルドが行われますが、パッケージ部分の更新にはbzrコマンドを使う必要があります。</p>
<p>bzrはgitに似た分散バージョン管理システムです。</p>
<p>以下、パッケージの更新に必要な各コマンドの使い方を説明します。</p>
<div class="section" id="launchpad">
<h3>launchpadコードレポジトリの利用に必要な初期設定<a class="headerlink" href="#launchpad" title="Permalink to this headline">¶</a></h3>
<p>launchpadコードレポジトリの利用にはlaunchpadアカウントが必要です。launchpadのホームページからアカウントを作成してください。</p>
<p>また、bzrを使うにはlaunchpadにsshの公開鍵を登録し、bzr launchpad-loginコマンドを使ってログインIDを設定する必要があります。
初期設定の詳細な手順については以下のページを参照してください。</p>
<p><a class="reference external" href="http://doc.bazaar.canonical.com/latest/en/mini-tutorial/">http://doc.bazaar.canonical.com/latest/en/mini-tutorial/</a></p>
</div>
<div class="section" id="id4">
<h3>ビルドに必要な依存ライブラリの追加<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>ソフトウェアが依存するライブラリが増えた場合などは、debian/controlファイルを編集して依存ライブラリを追加する必要があるでしょう。</p>
<p>そのような場合には、まず、ソースコードのdeb部分をチェックアウトします:</p>
<div class="highlight-python"><div class="highlight"><pre>$ bzr branch lp:~hrg/hrg-packaging/hrpsys-base-deb
</pre></div>
</div>
<p>debian/controlファイルを編集します:</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd hrpsys-base-deb
$ vi debian/control
</pre></div>
</div>
<p>bzrコマンドを使って変更をコミットしプッシュします:</p>
<div class="highlight-python"><div class="highlight"><pre>$ bzr add debian/control
$ bzr commit -m &quot;add dependent library&quot;
$ bzr push lp:~hrg/hrg-packaging/hrpsys-base-deb
</pre></div>
</div>
<p>コミットされた変更は後で自動でビルドされますが、後述するビルドの手動トリガ機能を使ってすぐにビルドさせて結果を確認することもできます。</p>
</div>
<div class="section" id="id5">
<h3>バージョン番号の更新<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Daily Buildパッケージは以下の規則によってバージョン番号が付与されます:</p>
<div class="highlight-python"><div class="highlight"><pre>[パッケージ名]-[upstreamバージョン番号]-[日付]-[レポジトリ連番]-[debianレポジトリ連番]
</pre></div>
</div>
<p>パッケージは外部レポジトリの更新があると自動でビルドされ連番が付与されますが、リリースによってバージョン番号が更新された場合は、debian/changelogファイルを編集してパッケージのupstreamバージョン番号を更新する必要があります。</p>
<p>そのような場合には、まず、ソースコードのdeb部分をチェックアウトします:</p>
<div class="highlight-python"><div class="highlight"><pre>$ bzr branch lp:~hrg/hrg-packaging/hrpsys-base-deb
</pre></div>
</div>
<p>dchコマンドを使ってdebian/changelogファイルを編集します:</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd hrpsys-base-deb
$ dch
</pre></div>
</div>
<p>bzrコマンドを使って変更をコミットしプッシュします:</p>
<div class="highlight-python"><div class="highlight"><pre>$ bzr add debian/changelog
$ bzr commit -m &quot;bump version number&quot;
$ bzr push lp:~hrg/hrg-packaging/hrpsys-base-deb
</pre></div>
</div>
<p>コミットされた変更は後で自動でビルドされますが、後述するビルドの手動トリガ機能を使ってすぐにビルドさせて結果を確認することもできます。</p>
</div>
</div>
<div class="section" id="id6">
<h2>ビルドの手動トリガ<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>recipeを使ったビルドには手動でトリガを発生させることができます。</p>
<p>手動でトリガを発生させるためにはページ下部の&#8221;Request build(s)&#8221;ボタンをクリックします。</p>
<p>すると以下のダイアログが開くので、出力したいPPAのURLを指定して&#8221;Request Builds&#8221;ボタンをクリックします。</p>
<p>出力したいPPAのURLにdailyのURLを指定するとパッケージのビルドを即座にテストできます。ここで、stableのURLを指定すると、ソフトウェアのバージョンアップなどのタイミングで行う安定版の選択的な出力をすることができます。</p>
<img alt="_images/manual-build.png" src="_images/manual-build.png" />
</div>
<div class="section" id="id7">
<h2>ビルド通知、自動ビルドの制御<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>ビルドが失敗した場合はメールでビルド通知が行われ、成功した場合は通知が行われません。launchpadではこの設定は固定でありユーザが変更することはできません。</p>
<p>特にパッケージ化のテスト中などの局面でメールが多く送信されるため、それらのメールが不要な場合はユーザの個人アカウントのページで、メールアドレスを予備のものに変更することでメールの新着通知に惑わされるのを避けることができます。</p>
<p>ビルド元のソースコードに大きな改変が加えられ、大量のビルドエラーメールが送信されるようになってしまった場合、自動ビルドを一時的に無効にすることでメールを止めることもできます。自動ビルドを無効にするにはrecipeのページでBuild scheduleの部分にある設定変更ボタンを押してBuilt dailyからBuilt on requestに設定を変更してください。</p>
<img alt="_images/set-dailybuild.png" src="_images/set-dailybuild.png" />
</div>
<div class="section" id="id8">
<h2>ビルドを行うオペレーティングシステムの種類を追加・削除する方法<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>ビルドを行うオペレーティングシステムの種類を追加・削除するにはrecipeのページのDistribution seriesの部分にある設定変更ボタンを押して、希望の種類を選択してください。</p>
<img alt="_images/set-distseries.png" src="_images/set-distseries.png" />
</div>
<div class="section" id="id9">
<h2>ビルドする対象ソフトウェアを追加・削除する方法<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>ビルドする対象ソフトウェアを追加するためには以下のプロジェクトページからConfigure code hostingをクリックします。</p>
<p><a class="reference external" href="https://code.launchpad.net/hrg-packaging">https://code.launchpad.net/hrg-packaging</a></p>
<p>コードをlaunchpad自身でホストする場合はLink to a Bazaar branchを選択(Branch名は空白)します。</p>
<p>外部レポジトリからインポートする場合はImport a branch hosted somewhere elseを選択しレポジトリのURLを入力し、レポジトリで使われているバージョン管理システムの種類を選択します。</p>
<p>Branch nameにはlaunchpad上のレポジトリの名前を設定します。</p>
<p>レポジトリが作成できたら次にrecipeを作成します。レポジトリのページを開き、Create packaging recipeボタンを押してください。</p>
<img alt="_images/create-recipe.png" src="_images/create-recipe.png" />
<p>Nameにはrecipeの名前を入力します。</p>
<p>Use an existing PPAからビルド結果の出力先PPAを選択します。</p>
<p>Default distribution seriesからビルドを行うオペレーティングシステムの種類を選択します。</p>
<p>Recipe textにはバージョン文字列のフォーマット、ベースブランチのURL、オーバーレイするブランチのURLを設定します。例えばhrpsys-baseの場合は以下の設定を行います。</p>
<div class="highlight-none"><div class="highlight"><pre># bzr-builder format 0.3 deb-version {debupstream}+{date}+{revno}+{revno:packaging}
lp:~hrg/hrg-packaging/hrpsys-base
nest-part packaging lp:~hrg/hrg-packaging/hrpsys-base-deb debian debian
</pre></div>
</div>
<p>オーバレイするブランチは複数指定することもできます。以下は、Choreonoidプラグイン用パッケージを作成する際にChoreonoid本体にプラグインレポジトリとdebianレポジトリをオーバレイした例です。</p>
<div class="highlight-none"><div class="highlight"><pre># bzr-builder format 0.3 deb-version {debupstream}+{date}+{revno}+{revno:plugin}+{revno:packaging}
lp:~hrg/hrg-packaging/choreonoid
nest plugin lp:~hrg/hrg-packaging/choreonoid-jvrc-plugin src/JVRCPlugin
nest-part packaging lp:~hrg/hrg-packaging/choreonoid-jvrc-plugin-deb debian debian
</pre></div>
</div>
<p>ソフトウェアに応じてURLを置き換えることでhrpsys-baseと同様の自動ビルドを行うことができます。</p>
<p>この例で使われているnest-partは特定のフォルダを完全に置き換える設定ですが、これ以外にも元のソースにパッチを当てることができるmergeなどを使うことができます。recipeの書き方の詳細については以下のページを参照してください。</p>
<p><a class="reference external" href="https://help.launchpad.net/Packaging/SourceBuilds/Recipes">https://help.launchpad.net/Packaging/SourceBuilds/Recipes</a></p>
<p>上記の設定をすべて行うことで自動ビルドが開始されます。</p>
<p>対象ソフトウェアを削除するには、まずrecipeの自動ビルドを無効化するかrecipe自体を削除することで新しいビルドの発生を停止します。</p>
<p>パッケージの古いバージョンも含めて削除(公開停止)したい場合はPPAのページでView package detailsボタンをクリックします。次にDelete packagesボタンをクリックして削除したいパッケージを選択してください。</p>
<p>レポジトリが不要な場合は、レポジトリについても合わせて削除してください。</p>
</div>
<div class="section" id="id10">
<h2>ビルドの前処理・後処理を変更する方法<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>ビルドに前処理・後処理が必要な場合は、debian/rulesファイルを編集して設定を追加します。</p>
<p>debian/rulesファイルはMakefile形式でclean, build, build-arch, build-indep, binary, binary-arch, binary-indepの各ターゲットに対して必要な処理を記述することができます。</p>
<p>build-*ターゲットにはroot権限を必要としない前処理・後処理を記述します。binary-*ターゲットにはroot権限が必要な処理を書くことができます。各ターゲットの役割の詳細については以下のページを参照してください。</p>
<p><a class="reference external" href="https://www.debian.org/doc/debian-policy/ch-source.html#s-debianrules">https://www.debian.org/doc/debian-policy/ch-source.html#s-debianrules</a></p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="user.html" class="btn btn-neutral" title="HRG packagingの利用方法(ユーザ向け)" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, AIST.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>